input {
  file {
    path => "/data/sensor_data.csv"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
}

filter {
  # ヘッダ行をスキップ
  if [message] =~ /^timestamp,/ {
    drop {}
  }

  csv {
    separator => ","
    columns => ["timestamp", "device_id", "device_name",
                 "vibration", "temperature", "current",
                 "pressure", "flow_rate"]
  }

  date {
    match => ["timestamp", "yyyy-MM-dd HH:mm:ss", "ISO8601"]
    target => "@timestamp"
  }

  mutate {
    convert => {
      "vibration"   => "float"
      "temperature" => "float"
      "current"     => "float"
      "pressure"    => "float"
      "flow_rate"   => "float"
    }
    remove_field => ["message", "host", "path", "timestamp", "event", "log", "@version"]
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    index => "sensor-data-%{+YYYY.MM}"
  }
  stdout {
    codec => dots
  }
}
