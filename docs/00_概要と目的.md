# ELKスタック予知保全PoC — 概要と目的

## このプロジェクトで実現したいこと

工場設備（ポンプ・モーター）のセンサーデータをELKスタックに取り込み、**異常検知 → 可視化 → アラート通知**の一連の流れを体験・検証する。

Azure案①（完成形デモ版）と同等の機能を、ローカルDocker環境で実現することが目標。

### ゴールイメージ

1. **センサーデータの取り込みと蓄積**: CSV → Logstash → Elasticsearch
2. **異常検知（GUI操作）**: Kibana の Machine Learning 画面から、コーディング不要で異常検知ジョブを作成
3. **異常検知（ML）**: Python + LightGBM で故障予兆スコアを算出（高度なカスタマイズが必要な場合）
4. **ダッシュボード可視化**: Kibana でセンサー推移・予兆スコア・アラート一覧を一画面で確認
5. **アラート通知**: 異常スコアが閾値を超えた場合に通知（ElastAlert2）

## Azure構成との対応関係

| 役割 | Azure構成（案①） | ELKスタック構成 |
| --- | --- | --- |
| データ取り込み・変換 | Databricks（ETL） | **Logstash** / Pythonスクリプト |
| データ蓄積・検索 | Data Lake + SQL Database | **Elasticsearch** |
| 可視化・ダッシュボード | Power BI | **Kibana** |
| 異常検知（AI） | Databricks AutoML | **Elasticsearch ML**（GUI） / Python |
| 異常検知（閾値） | Databricks | **Elasticsearch Watcher** / Python |
| 通知 | Logic Apps → Teams/メール | **ElastAlert2** → メール/Webhook |
| 実行環境 | Azure クラウド | **Docker**（ローカル） |

## ELKスタック構成の利点

- **コスト0円**: ローカルDocker環境で動作するため、クラウド課金が発生しない
- **GUI分析が強い**: Kibana上でクリック操作だけで異常検知モデルの作成・結果確認ができる
- **Anomaly Swimlane**: Elasticsearch ML固有の可視化で、異常の時系列パターンが直感的
- **オフライン動作**: インターネット接続なしで完全動作
- **高速な試行錯誤**: ローカルで即座にデータ投入→分析→可視化のサイクルを回せる

## ELKスタック構成の注意点

- **リソース制約**: Elasticsearch + Kibana + Logstash で最低4GBのメモリが必要
- **X-Pack ライセンス**: Elasticsearch ML は Trial ライセンス（30日間）。本番利用にはサブスクリプションが必要
- **本番移行**: ローカル検証後にクラウド環境への移行作業が発生する

## サンプルデータの概要

学習用に3ヶ月分のセンサーデータを用意している。

### 設備（3台）

| 設備ID | 設備名 | 種別 | 設置場所 |
| --- | --- | --- | --- |
| pump-01 | ポンプA-01 | ポンプ | A棟1F |
| pump-02 | ポンプA-02 | ポンプ | A棟1F |
| motor-01 | モーターB-01 | モーター | B棟2F |

### 故障イベント（3件）

| 設備 | 故障日 | 故障モード | 説明 |
| --- | --- | --- | --- |
| pump-01 | 2026-01-20 | ベアリング劣化 | 異音発生により停止・ベアリング交換 |
| pump-01 | 2026-02-15 | モーター過熱 | 温度上昇により保護停止 |
| motor-01 | 2026-02-05 | ベアリング劣化 | 振動値上昇・計画停止で交換 |

### データの特徴

- 10分間隔、3台×3ヶ月 = 約38,880行
- **故障の7日前**から徐々にセンサー値が悪化するパターンを組み込んでいる
- ベアリング劣化: 振動値が二次関数的に上昇
- モーター過熱: 温度が二次関数的に上昇
- センサー間の相関もシミュレーション（振動↑ → 電流↑、温度↑ → 電流↑）

## 異常検知の2つのアプローチ

### 方法1（推奨）: Elasticsearch ML — GUI操作のみ

Kibana の Machine Learning 画面から、クリック操作だけで異常検知が可能。PoCの初期段階ではこの方法を推奨する。

```
Kibana → Machine Learning → Anomaly Detection → ジョブ作成
  → sensor-data-* インデックスを選択
  → 振動・温度・電流を分析対象に設定
  → ジョブ実行
  → Anomaly Explorer で結果確認
```

**メリット**: コーディング不要、結果の可視化も組み込み、すぐに試せる

### 方法2: Python ML — 高度なカスタマイズ用

独自の特徴量設計、特定アルゴリズム（LightGBM等）、故障履歴を使った教師あり学習が必要な場合に採用する。

```
docker exec python-ml python train_model.py       # 学習
docker exec python-ml python batch_inference.py    # 推論 → ES書き戻し
```

**メリット**: アルゴリズムの選択が自由、特徴量エンジニアリングが可能

## 可視化（Kibanaダッシュボード）で作りたいもの

### ダッシュボード1: 設備全体サマリー

- 設備ステータス（正常/注意/異常の台数）— Metric Visualization
- 予兆スコアのヒートマップ（設備×時間）— Lens: Heat Map
- 異常検知アラート一覧 — Data Table / Discover

### ダッシュボード2: 個別設備の詳細

- センサー値の時系列グラフ（振動・温度・電流 + 閾値ライン）— Lens: Line Chart
- 予兆スコアの推移 — Lens: Line Chart
- Anomaly Swimlane（ML組み込みビジュアル）

### ダッシュボード3: AI vs 閾値の比較

- 検知精度の比較 — Metric Visualization
- 検知タイミングの比較（AI vs 閾値）— Lens: Line Chart

## 通知フロー

```
Elasticsearch（prediction-results インデックス）
  → ElastAlert2（1分間隔でポーリング）
    → 異常レベル判定
      → 注意（スコア 0.7-0.85）: ログ出力
      → 警告（スコア 0.85-0.95）: メール/Webhook
      → 危険（スコア > 0.95）: メール + Webhook
```

## 学習の進め方

詳細な手順は [01_学習手順.md](01_学習手順.md) を参照。
